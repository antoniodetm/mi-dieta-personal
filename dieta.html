<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mi Dieta Pro</title>
    <style>
        :root {
            --bg: #f0f2f5; --card: #ffffff; --text: #1a1a1a; --accent: #007aff;
            --proteina: #ff3b30; --vegetal: #34c759; --carbo: #ff9500; --lacteo: #af52de;
            --semana1: #5856d6; --semana2: #007aff;
        }

        body { font-family: -apple-system, system-ui, sans-serif; background-color: var(--bg); margin: 0; padding: 5px; color: var(--text); scroll-behavior: smooth; padding-bottom: 60px; }
        
        .toolbar { display: flex; gap: 8px; margin-bottom: 10px; position: sticky; top: 0; z-index: 100; background: rgba(240, 242, 245, 0.9); backdrop-filter: blur(8px); padding: 5px 0; }
        .btn-tool { flex: 1; padding: 10px; border-radius: 10px; border: none; color: white; font-weight: bold; font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-transform: uppercase; }
        .btn-save { background: linear-gradient(135deg, #28cd41, #1db954); }
        .btn-sync { background: linear-gradient(135deg, #007aff, #0051a8); }

        h1 { font-size: 22px; text-align: center; color: #1c1c1e; margin: 5px 0 10px 0; }

        .semana-header { padding: 8px; color: white; border-radius: 8px; margin: 15px 0 8px 0; text-align: center; font-weight: 800; font-size: 14px; text-transform: uppercase; }
        .s1 { background: var(--semana1); }
        .s2 { background: var(--semana2); }

        .dia-card { background: var(--card); border-radius: 15px; padding: 12px; margin-bottom: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); scroll-margin-top: 60px; }
        .dia-nombre { font-weight: 800; font-size: 18px; margin-bottom: 10px; color: var(--accent); border-bottom: 1px solid #eee; padding-bottom: 5px; }

        .bloque-ingesta { margin-bottom: 10px; padding: 8px; border-radius: 12px; background: #fafafa; border: 1px solid #eee; scroll-margin-top: 70px; }
        .label-ingesta { font-weight: 800; font-size: 10px; text-transform: uppercase; margin-bottom: 5px; display: block; color: #777; }
        
        .plato-wrapper { display: flex; align-items: center; gap: 6px; margin-bottom: 6px; }
        .plato-input { flex: 1; font-size: 15px; font-weight: 700; padding: 8px; background: white; border-radius: 8px; border: 1px solid #d1d1d6; outline: none; color: #000; min-height: 18px; }
        .btn-ir-receta { font-size: 16px; background: #f2f2f7; border: 1px solid #d1d1d6; padding: 6px 10px; border-radius: 8px; text-decoration: none; cursor: pointer; }

        .cat-box { margin-bottom: 4px; border-radius: 6px; padding: 4px 8px; display: flex; flex-direction: column; }
        .cat-name { font-size: 9px; font-weight: 900; letter-spacing: 0.3px; line-height: 1; margin-bottom: 2px; }
        .ing-input { font-size: 13px; min-height: 16px; outline: none; font-weight: 500; line-height: 1.2; }

        .cat-prot { background: #fff1f0; border-left: 3px solid var(--proteina); color: #a9150b; }
        .cat-veg { background: #f6ffed; border-left: 3px solid var(--vegetal); color: #135200; }
        .cat-carb { background: #fff7e6; border-left: 3px solid var(--carbo); color: #874d00; }
        .cat-lact { background: #f9f0ff; border-left: 3px solid var(--lacteo); color: #531dab; }

        .lista-compra-seccion { background: #1c1c1e; color: white; border-radius: 18px; padding: 15px; margin-top: 20px; }
        .lista-compra-seccion h2 { font-size: 18px; margin: 0 0 10px 0; }
        .item-check { display: flex; align-items: flex-start; padding: 8px 0; border-bottom: 1px solid #333; font-size: 14px; cursor: pointer; }
        .item-check.comprado { opacity: 0.4; text-decoration: line-through; }
        
        .checkbox { width: 20px; height: 20px; border: 2px solid var(--accent); border-radius: 6px; margin-right: 12px; flex-shrink: 0; position: relative; margin-top: 2px; }
        .comprado .checkbox { background: var(--accent); }
        .comprado .checkbox::after { content: "‚úì"; color: white; position: absolute; left: 4px; top: -2px; font-size: 16px; font-weight: bold; }

        .ref-plato-container { font-size: 8px; color: #888; margin-left: auto; text-transform: uppercase; font-weight: 600; text-align: right; padding-left: 10px; line-height: 1.2; max-width: 45%; }
        .ref-plato-line { display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .elaboraciones-seccion { background: white; border-radius: 18px; padding: 15px; margin-top: 20px; border: 1px solid #ddd; }
        .receta-card { margin-bottom: 25px; scroll-margin-top: 75px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        .receta-titulo-box { font-size: 15px; font-weight: 800; color: #d32f2f; margin-bottom: 4px; border-left: 3px solid #d32f2f; padding-left: 8px; display: block; }
        .receta-texto-editable { font-size: 14px; padding: 10px; border-radius: 10px; line-height: 1.4; border: 1px dashed #ccc; outline: none; background: #fdfdfd; min-height: 40px; }
        
        /* Bot√≥n de vuelta */
        .btn-volver-menu { display: inline-block; margin-top: 8px; font-size: 11px; font-weight: bold; color: var(--accent); background: #eef6ff; padding: 5px 10px; border-radius: 6px; border: 1px solid var(--accent); cursor: pointer; }
    </style>
</head>
<body>

    <div class="toolbar">
        <button class="btn-tool btn-save" onclick="exportarJSON()">üíæ Guardar</button>
        <button class="btn-tool btn-sync" onclick="sincronizarDesdeGithub()">üîÑ RECARGAR</button>
    </div>

    <h1>üçé Mi Men√∫</h1>
    <div id="app"></div>

    <div class="lista-compra-seccion">
        <h2>üõí Lista de la Compra</h2>
        <div id="lista-detallada"></div>
    </div>

    <div class="elaboraciones-seccion" id="todas-elaboraciones">
        <h2>üë®‚Äçüç≥ Gu√≠a de Elaboraci√≥n</h2>
        <div id="contenedor-recetas"></div>
    </div>

    <script>
        const URL_GITHUB_JSON = 'https://raw.githubusercontent.com/TU_USUARIO/TU_REPO/main/dieta_datos.json';
        
        const dias = ["Lunes", "Martes", "Mi√©rcoles", "Jueves", "Viernes", "S√°bado", "Domingo"];
        const categorias = [
            {id: 'prot', nombre: 'Prote√≠nas', clase: 'cat-prot', color: 'var(--proteina)'},
            {id: 'veg', nombre: 'Verduras', clase: 'cat-veg', color: 'var(--vegetal)'},
            {id: 'carb', nombre: 'Hidratos', clase: 'cat-carb', color: 'var(--carbo)'},
            {id: 'lact', nombre: 'L√°cteos/Frutos', clase: 'cat-lact', color: 'var(--lacteo)'}
        ];

        function renderizar() {
            let htmlApp = "";
            for (let s = 1; s <= 2; s++) {
                htmlApp += `<div class="semana-header s${s}">Semana ${s}</div>`;
                for (let d = 0; d < 7; d++) {
                    htmlApp += `<div class="dia-card">
                        <div class="dia-nombre">${dias[d]}</div>
                        ${renderBloque(s, d, 'Comida', 'üçΩÔ∏è')}
                        ${renderBloque(s, d, 'Cena', 'üåô')}
                    </div>`;
                }
            }
            document.getElementById('app').innerHTML = htmlApp;
            cargarLocalStorage();
            actualizarGuia();
        }

        function renderBloque(sem, dia, tipo, icono) {
            const idInput = `s${sem}-${tipo}-plato-${dia}`;
            const idContenedor = `bloque-${idInput}`;
            return `<div class="bloque-ingesta" id="${idContenedor}">
                <span class="label-ingesta">${icono} ${tipo}</span>
                <div class="plato-wrapper">
                    <div class="plato-input" contenteditable="true" id="${idInput}" oninput="gestionarCambio(this)"></div>
                    <button class="btn-ir-receta" onclick="irAReceta('${idInput}')">üìñ</button>
                </div>
                ${categorias.map(cat => `
                    <div class="cat-box ${cat.clase}">
                        <div class="cat-name">${cat.nombre}</div>
                        <div class="ing-input" contenteditable="true" id="s${sem}-${tipo}-${cat.id}-${dia}" oninput="gestionarCambio(this)"></div>
                    </div>`).join('')}
            </div>`;
        }

        function irAReceta(idPlato) {
            document.getElementById(`guia-${idPlato}`).scrollIntoView();
        }

        function volverAMenu(idPlato) {
            document.getElementById(`bloque-${idPlato}`).scrollIntoView();
        }

        function gestionarCambio(el) {
            localStorage.setItem(el.id, el.innerText);
            if(el.classList.contains('plato-input')) actualizarGuia();
            actualizarLista();
        }

        function actualizarGuia() {
            const contenedor = document.getElementById('contenedor-recetas');
            let htmlRecetas = "";
            document.querySelectorAll('.plato-input').forEach(input => {
                const nombre = input.innerText.trim() || "Plato nuevo";
                const idRecText = `receta-text-${input.id}`;
                const valorRec = localStorage.getItem(idRecText) || "Pasos...";
                htmlRecetas += `
                <div class="receta-card" id="guia-${input.id}">
                    <span class="receta-titulo-box">${nombre}</span>
                    <div class="receta-texto-editable" contenteditable="true" id="${idRecText}" oninput="localStorage.setItem(this.id, this.innerText)">${valorRec}</div>
                    <div class="btn-volver-menu" onclick="volverAMenu('${input.id}')">Volver al Men√∫ ‚Üë</div>
                </div>`;
            });
            contenedor.innerHTML = htmlRecetas;
        }

        function actualizarLista() {
            const contenedor = document.getElementById('lista-detallada');
            let html = "";
            
            categorias.forEach(cat => {
                let mapaIngredientes = {}; 
                
                document.querySelectorAll(`[id*="-${cat.id}-"]`).forEach(inputIng => {
                    if(inputIng.innerText.trim()) {
                        const partesId = inputIng.id.split('-');
                        const idPlatoRel = `${partesId[0]}-${partesId[1]}-plato-${partesId[3]}`;
                        const nombrePlato = document.getElementById(idPlatoRel)?.innerText.trim() || "S/N";
                        
                        const listaIng = inputIng.innerText.split(/[\n,]+/).map(i => i.trim()).filter(i => i);
                        
                        listaIng.forEach(ing => {
                            let nombreFormateado = ing.charAt(0).toUpperCase() + ing.slice(1).toLowerCase();
                            if(!mapaIngredientes[nombreFormateado]) {
                                mapaIngredientes[nombreFormateado] = new Set();
                            }
                            mapaIngredientes[nombreFormateado].add(nombrePlato);
                        });
                    }
                });

                let clavesOrdenadas = Object.keys(mapaIngredientes).sort((a, b) => a.localeCompare(b));

                if(clavesOrdenadas.length > 0) {
                    html += `<div style="margin-top:12px; color:${cat.color}; font-size:11px; font-weight:900; text-transform:uppercase;">${cat.nombre}</div>`;
                    clavesOrdenadas.forEach(nombre => {
                        const idCheck = `check-${nombre.toLowerCase().replace(/\s/g,'')}`;
                        const isChecked = localStorage.getItem(idCheck) === 'true' ? 'comprado' : '';
                        const platosHTML = Array.from(mapaIngredientes[nombre]).map(p => `<span class="ref-plato-line">${p}</span>`).join('');
                        
                        html += `
                        <div class="item-check ${isChecked}" onclick="toggleCheck('${idCheck}', this)">
                            <div class="checkbox"></div>
                            <span style="flex: 1; margin-top: 3px;">${nombre}</span>
                            <div class="ref-plato-container">${platosHTML}</div>
                        </div>`;
                    });
                }
            });
            contenedor.innerHTML = html || "<p style='font-size:12px; color:#666'>Lista vac√≠a.</p>";
        }

        function toggleCheck(id, el) {
            const m = el.classList.toggle('comprado');
            localStorage.setItem(id, m);
        }

        function cargarLocalStorage() {
            document.querySelectorAll('[contenteditable="true"]').forEach(campo => {
                const v = localStorage.getItem(campo.id);
                if (v) campo.innerText = v;
            });
            actualizarLista();
        }

        async function sincronizarDesdeGithub() {
            if (URL_GITHUB_JSON.includes('TU_USUARIO')) { alert("Configura la URL de GitHub."); return; }
            try {
                const r = await fetch(`${URL_GITHUB_JSON}?v=${new Date().getTime()}`);
                const d = await r.json();
                if (confirm("¬øRECARGAR datos de GitHub?")) {
                    localStorage.clear();
                    for (let k in d) { localStorage.setItem(k, d[k]); }
                    location.reload();
                }
            } catch (e) { alert("Error."); }
        }

        function exportarJSON() {
            let d = {};
            for (let i = 0; i < localStorage.length; i++) {
                let k = localStorage.key(i); d[k] = localStorage.getItem(k);
            }
            let s = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(d));
            let a = document.createElement('a'); a.href = s; a.download = "dieta_datos.json"; a.click();
        }

        renderizar();
    </script>
</body>
</html>