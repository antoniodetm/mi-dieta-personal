<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mi Dieta - Vista Lista</title>
    <style>
        :root {
            --bg: #f2f2f7; --card: #ffffff; --text: #1c1c1e; --accent: #007aff;
            --proteina: #ff3b30; --vegetal: #34c759; --carbo: #ff9500; --lacteo: #af52de;
        }

        body { font-family: -apple-system, system-ui, sans-serif; background-color: var(--bg); margin: 0; padding: 0; color: var(--text); scroll-behavior: smooth; }
        
        .toolbar { 
            display: flex; gap: 4px; position: sticky; top: 0; z-index: 9999; 
            background: rgba(242, 242, 247, 0.95); backdrop-filter: blur(10px); 
            padding: 8px 6px; border-bottom: 1px solid #d1d1d6; 
        }

        .btn-tool { flex: 1; padding: 12px 2px; border-radius: 8px; border: none; color: white; font-weight: 700; font-size: 8px; cursor: pointer; text-transform: uppercase; }
        .btn-home { background: #3a3a3c; }
        .btn-menu { background: #5856d6; }
        .btn-compra { background: #ff9500; }
        .btn-sync { background: #007aff; }
        .btn-save { background: #28cd41; }

        .titulo-seccion { text-align: center; font-size: 22px; font-weight: 900; margin: 15px 0; color: var(--text); }
        .vista { display: none; padding: 8px; }

        /* DASHBOARD - AHORA EN FILAS DE ANCHO COMPLETO */
        .dashboard { display: flex; flex-direction: column; gap: 10px; }
        .dash-semana { font-weight: 800; font-size: 11px; margin: 15px 0 5px; color: #8e8e93; text-transform: uppercase; border-bottom: 0.5px solid #d1d1d6; padding-bottom: 4px; }
        .dash-dia { background: white; padding: 12px; border-radius: 14px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: relative; border: 1px solid transparent; }
        .dash-dia.hoy { border: 2px solid var(--accent); background: #f0f7ff; }
        .dash-dia-texto { font-weight: 800; font-size: 15px; color: var(--accent); margin-bottom: 4px; display: block; padding-right: 35px; }
        .dash-plato-resumen { font-size: 12px; color: #3a3a3c; margin-top: 2px; }
        
        /* Checkbox en Dashboard */
        .dash-check { position: absolute; top: 12px; right: 12px; width: 22px; height: 22px; accent-color: var(--accent); z-index: 10; cursor: pointer; }
        .dash-click-area { cursor: pointer; }

        /* MENU */
        .semana-header { padding: 8px; color: white; border-radius: 8px; margin: 10px 0; text-align: center; font-weight: 800; background: #5856d6; }
        .dia-card { background: white; border-radius: 16px; padding: 12px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); scroll-margin-top: 75px; }
        .dia-nombre-fecha { font-weight: 800; font-size: 18px; color: var(--accent); border-bottom: 1px solid #f2f2f7; padding-bottom: 4px; display: block; margin-bottom: 10px; }
        .bloque-ingesta { margin-bottom: 10px; padding: 8px; border-radius: 12px; background: #f9f9f9; border: 0.5px solid #e5e5ea; scroll-margin-top: 80px; }
        .plato-input { font-size: 14px; font-weight: 700; padding: 8px; background: white; border-radius: 8px; border: 1px solid #d1d1d6; outline: none; flex: 1; }

        /* CATEGOR√çAS */
        .cat-box { margin-bottom: 4px; border-radius: 6px; padding: 4px 8px; border-left: 4px solid #ccc; position: relative; }
        .cat-group-tag { font-size: 7px; font-weight: 900; text-transform: uppercase; color: rgba(0,0,0,0.3); position: absolute; top: 1px; left: 8px; }
        .ing-input { font-size: 13px; outline: none; min-height: 16px; padding-top: 6px; }
        .cat-prot { border-color: var(--proteina); background: #fff1f0; }
        .cat-veg { border-color: var(--vegetal); background: #f6ffed; }
        .cat-carb { border-color: var(--carbo); background: #fff7e6; }
        .cat-lact { border-color: var(--lacteo); background: #f9f0ff; }

        /* COMPRA */
        .compra-container { background: white; border-radius: 20px; padding: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .item-check { display: flex; align-items: center; padding: 12px 0; border-bottom: 0.5px solid #f2f2f7; cursor: pointer; }
        .item-check.comprado { opacity: 0.3; text-decoration: line-through; }
        .checkbox-estilo { width: 20px; height: 20px; border: 2px solid var(--accent); border-radius: 6px; margin-right: 12px; flex-shrink: 0; }
        .comprado .checkbox-estilo { background: var(--accent); }
        .ref-plato { font-size: 9px; color: #8e8e93; margin-left: auto; text-align: right; }

        /* RECETAS */
        .receta-card { background: #fff; padding: 15px; border-radius: 16px; margin-bottom: 25px; border: 1px solid #eee; scroll-margin-top: 85px; }
        .receta-titulo { color: #d32f2f; font-weight: 800; border-left: 4px solid #d32f2f; padding-left: 8px; margin-bottom: 10px; display: block; }
        .receta-text { font-size: 14px; padding: 12px; background: #fafafa; border-radius: 10px; border: 1px dashed #ccc; outline: none; min-height: 50px; }
    </style>
</head>
<body>

    <div class="toolbar">
        <button class="btn-tool btn-home" onclick="cambiarVista('dashboard')">üè† INICIO</button>
        <button class="btn-tool btn-menu" onclick="cambiarVista('menu')">üìã MEN√ö</button>
        <button class="btn-tool btn-compra" onclick="cambiarVista('compra')">üõí COMPRA</button>
        <button class="btn-tool btn-sync" onclick="sincronizar()">üîÑ SYNC</button>
        <button class="btn-tool btn-save" onclick="exportarJSON()">üíæ SAVE</button>
    </div>

    <div id="vista-dashboard" class="vista" style="display: block;">
        <h1 id="titulo-dash" class="titulo-seccion">Mi Planificaci√≥n</h1>
        <div id="dash-content" class="dashboard"></div>
    </div>

    <div id="vista-menu" class="vista">
        <div id="menu-content"></div>
        <h1 class="titulo-seccion">üë®‚Äçüç≥ Elaboraci√≥n</h1>
        <div id="recetas-content"></div>
    </div>

    <div id="vista-compra" class="vista">
        <h1 class="titulo-seccion">Lista de Compra</h1>
        <p style="font-size: 10px; text-align: center; color: #8e8e93; margin-top: -10px;">(Basado en los d√≠as marcados en Inicio)</p>
        <div id="lista-detallada" class="compra-container"></div>
    </div>

    <script>
        const diasSemana = ["Lunes", "Martes", "Mi√©rcoles", "Jueves", "Viernes", "S√°bado", "Domingo"];
        const cats = [{id: 'prot', n: 'Prote√≠na', c: 'cat-prot', col: 'var(--proteina)'}, {id: 'veg', n: 'Verdura', c: 'cat-veg', col: 'var(--vegetal)'}, {id: 'carb', n: 'Hidratos', c: 'cat-carb', col: 'var(--carbo)'}, {id: 'lact', n: 'L√°cteos', c: 'cat-lact', col: 'var(--lacteo)'}];

        const FECHA_BASE = new Date(2026, 0, 19); 
        
        function getInfoSemanaActual() {
            const hoy = new Date();
            const diffDias = Math.floor((hoy - FECHA_BASE) / (1000 * 60 * 60 * 24));
            const semanaRelativa = Math.floor(diffDias / 7);
            const startSemana = diffDias < 0 ? 0 : semanaRelativa;
            return { inicioSemana1: startSemana, inicioSemana2: startSemana + 1 };
        }

        function obtenerFechaPorSemanaIndice(indiceSemanaGlobal, indiceDia) {
            let f = new Date(FECHA_BASE);
            f.setDate(f.getDate() + (indiceSemanaGlobal * 7) + indiceDia);
            return f;
        }

        function renderDashboard() {
            const info = getInfoSemanaActual();
            let html = "";
            let hoyStr = new Date().toDateString();

            [info.inicioSemana1, info.inicioSemana2].forEach((semGlobal) => {
                const numSemanaDieta = (semGlobal % 2) === 0 ? 1 : 2;
                html += `<div class="dash-semana">Semana de Dieta ${numSemanaDieta}</div>`;
                
                for (let d = 0; d < 7; d++) {
                    const fecha = obtenerFechaPorSemanaIndice(semGlobal, d);
                    const checkId = `dia-completo-s${numSemanaDieta}-${d}`;
                    const isChecked = localStorage.getItem(checkId) === 'true' ? 'checked' : '';
                    const tC = localStorage.getItem(`s${numSemanaDieta}-Comida-plato-${d}`) || "";
                    const tN = localStorage.getItem(`s${numSemanaDieta}-Cena-plato-${d}`) || "";
                    const esHoy = hoyStr === fecha.toDateString();

                    html += `
                    <div class="dash-dia ${esHoy ? 'hoy' : ''}">
                        <input type="checkbox" class="dash-check" id="${checkId}" ${isChecked} onchange="localStorage.setItem(this.id, this.checked)">
                        <div class="dash-click-area" onclick="irADia(${numSemanaDieta}, ${d})">
                            <span class="dash-dia-texto">${diasSemana[d]} ${fecha.getDate()}</span>
                            <div class="dash-plato-resumen"><b>Comida:</b> ${tC || "---"}</div>
                            <div class="dash-plato-resumen"><b>Cena:</b> ${tN || "---"}</div>
                        </div>
                    </div>`;
                }
            });
            document.getElementById('dash-content').innerHTML = html;
        }

        function irADia(numSemanaDieta, d) {
            cambiarVista('menu');
            setTimeout(() => { document.getElementById(`dia-s${numSemanaDieta}-${d}`)?.scrollIntoView(); }, 150);
        }

        function renderMenu() {
            let html = "";
            [1, 2].forEach(s => {
                html += `<div class="semana-header">Bloque Fijo: Semana ${s}</div>`;
                for (let d = 0; d < 7; d++) {
                    html += `
                    <div class="dia-card" id="dia-s${s}-${d}">
                        <span class="dia-nombre-fecha">${diasSemana[d]} (Semana ${s})</span>
                        ${renderBloque(s, d, 'Comida', 'üçΩÔ∏è')}
                        ${renderBloque(s, d, 'Cena', 'üåô')}
                    </div>`;
                }
            });
            document.getElementById('menu-content').innerHTML = html;
            cargarDatos();
        }

        function renderBloque(s, d, tipo, ico) {
            const id = `s${s}-${tipo}-plato-${d}`;
            return `
            <div class="bloque-ingesta" id="bloque-${id}">
                <div style="display:flex; gap:6px; align-items:center; margin-bottom:8px;">
                    <span style="font-size:10px;">${ico}</span>
                    <div class="plato-input" contenteditable="true" id="${id}" oninput="guardar(this)"></div>
                    <button style="border:none; background:#eee; padding:6px; border-radius:6px; cursor:pointer;" onclick="document.getElementById('guia-${id}').scrollIntoView()">üìñ</button>
                </div>
                ${cats.map(c => `
                    <div class="cat-box ${c.c}">
                        <span class="cat-group-tag">${c.n}</span>
                        <div class="ing-input" contenteditable="true" id="s${s}-${tipo}-${c.id}-${d}" oninput="guardar(this)"></div>
                    </div>`).join('')}
            </div>`;
        }

        function guardar(el) {
            localStorage.setItem(el.id, el.innerText);
            if(el.id.includes('plato')) actualizarRecetas();
        }

        function actualizarRecetas() {
            let html = "";
            document.querySelectorAll('.plato-input').forEach(input => {
                const nom = input.innerText.trim() || "Plato";
                const idRec = `receta-text-${input.id}`;
                html += `<div class="receta-card" id="guia-${input.id}">
                    <span class="receta-titulo">${nom}</span>
                    <div class="receta-text" contenteditable="true" id="${idRec}" oninput="localStorage.setItem(this.id, this.innerText)">${localStorage.getItem(idRec) || "..."}</div>
                    <button style="background:#f0f0f5; color:var(--accent); border:1px solid var(--accent); border-radius:8px; padding:8px; font-size:10px; font-weight:bold; margin-top:10px; width:100%; cursor:pointer;" onclick="document.getElementById('bloque-${input.id}').scrollIntoView()">Volver al Plato ‚Üë</button>
                </div>`;
            });
            document.getElementById('recetas-content').innerHTML = html;
        }

        function actualizarLista() {
            const cont = document.getElementById('lista-detallada');
            let html = "";
            cats.forEach(c => {
                let mapa = {};
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.includes(`-${c.id}-`)) {
                        const p = key.split('-');
                        const diaCheckId = `dia-completo-${p[0]}-${p[3]}`;
                        
                        if (localStorage.getItem(diaCheckId) === 'true') {
                            const val = localStorage.getItem(key).trim();
                            if (val) {
                                const platoNom = localStorage.getItem(`${p[0]}-${p[1]}-plato-${p[3]}`) || "S/N";
                                val.split(/[\n,]+/).map(ing => ing.trim()).filter(ing => ing).forEach(ing => {
                                    let f = ing.charAt(0).toUpperCase() + ing.slice(1).toLowerCase();
                                    if (!mapa[f]) mapa[f] = new Set();
                                    mapa[f].add(`${platoNom} (S${p[0].replace('s','')})`);
                                });
                            }
                        }
                    }
                }
                if (Object.keys(mapa).length > 0) {
                    html += `<div style="color:${c.col}; font-size:12px; font-weight:900; margin:15px 0 5px; text-transform:uppercase;">${c.n}</div>`;
                    Object.keys(mapa).sort().forEach(k => {
                        html += `<div class="item-check" onclick="this.classList.toggle('comprado')"><div class="checkbox-estilo"></div><span style="flex:1; font-size:14px;">${k}</span><div class="ref-plato">${Array.from(mapa[k]).join('<br>')}</div></div>`;
                    });
                }
            });
            cont.innerHTML = html || "<p style='text-align:center; color:#999; padding:20px;'>Marca los d√≠as que quieras comprar en 'Mi Planificaci√≥n'.</p>";
        }

        function cambiarVista(id) {
            document.querySelectorAll('.vista').forEach(v => v.style.display = 'none');
            document.getElementById('vista-' + id).style.display = 'block';
            window.scrollTo(0,0);
            if(id === 'compra') actualizarLista();
            if(id === 'dashboard') renderDashboard();
        }

        async function sincronizar() {
            if(!confirm("¬øSincronizar?")) return;
            try {
                const r = await fetch('https://raw.githubusercontent.com/antoniodetm/mi-dieta-personal/refs/heads/main/dieta_datos.json');
                const d = await r.json();
                Object.keys(d).forEach(k => localStorage.setItem(k, d[k]));
                location.reload();
            } catch(e) { alert("Error"); }
        }

        function cargarDatos() {
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                const el = document.getElementById(key);
                if (el) {
                    if (el.type === 'checkbox') el.checked = (localStorage.getItem(key) === 'true');
                    else el.innerText = localStorage.getItem(key);
                }
            }
            actualizarRecetas();
        }

        function exportarJSON() {
            let d = {}; for(let i=0; i<localStorage.length; i++){ let k = localStorage.key(i); d[k] = localStorage.getItem(k); }
            let a = document.createElement('a'); a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(d)); a.download = "dieta.json"; a.click();
        }

        renderMenu(); renderDashboard();
    </script>
</body>
</html>